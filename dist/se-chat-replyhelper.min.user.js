/*

// ==UserScript==
// @name           Chat Reply Helper for Stack Exchange sites
// @namespace      http://oliversalzburg.github.com/
// @version        2.5.1
// @description    Handle structured conversations more conveniently
// @homepage       https://github.com/oliversalzburg/se-chat-reply-highlight
// @grant          none
// @include /^https?:\/\/chat\.stackexchange\.com/.*$/
// @include /^https?:\/\/chat\.stackoverflow\.com/.*$/
// @include /^https?:\/\/chat\.meta\.stackexchange\.com/.*$/

// ==/UserScript==
*/
(function(b,a,e,f){b.fn.caret=function(c,h){var d,g,l=this[0],k=b.browser.msie;if("object"===typeof c&&"number"===typeof c.start&&"number"===typeof c.end)d=c.start,g=c.end;else if("number"===typeof c&&"number"===typeof h)d=c,g=h;else if("string"===typeof c)-1<(d=l.value.indexOf(c))?g=d+c[a]:d=null;else if("[object RegExp]"===Object.prototype.toString.call(c)){var p=c.exec(l.value);null!=p&&(d=p.index,g=d+p[0][a])}if("undefined"!=typeof d)return k?(k=this[0].createTextRange(),k.collapse(!0),k.moveStart("character",
d),k.moveEnd("character",g-d),k.select()):(this[0].selectionStart=d,this[0].selectionEnd=g),this[0].focus(),this;if(k)if(g=document.selection,"textarea"!=this[0].tagName.toLowerCase()){k=this.val();d=g[e]()[f]();d.moveEnd("character",k[a]);var m=""==d.text?k[a]:k.lastIndexOf(d.text);d=g[e]()[f]();d.moveStart("character",-k[a]);var n=d.text[a]}else d=g[e](),g=d[f](),g.moveToElementText(this[0]),g.setEndPoint("EndToEnd",d),m=g.text[a]-d.text[a],n=m+d.text[a];else m=l.selectionStart,n=l.selectionEnd;
d=l.value.substring(m,n);return{start:m,end:n,text:d,replace:function(b){return l.value.substring(0,m)+b+l.value.substring(n,l.value[a])}}}})($,"length","createRange","duplicate");$.fn.reverse=[].reverse;function ReplyHelper(){this.insertStyles();this.registerHandler();this.enableQuoteBubble()}
ReplyHelper.prototype={quotedMessage:null,replyTo:function(b,a){a=a||":";var e="";":"==a||a.match(/ $/)||(e=" ");var f=$("#input"),c=f.caret().start,e=f.val().replace(RegExp("^"+a+"\\d* ?"),a+e+b+" ");f.val(e);f.caret(c,c)},scrollTo:function(b){var a=$("main.scrollable");a.length?(b=b.offset().top-a.offset().top+a.scrollTop()-b.closest(".user-container").find(".signature").height(),0>b&&(b=0),a.animate({scrollTop:b},50)):b.offset()&&(b=b.offset().top-10,0>b&&(b=0),$("html, body").animate({scrollTop:b},
50))},insertStyles:function(){var b=document.createElement("style");b.textContent="div.message.reply-parent, div.message.reply-child { background-color: silver; }";b.type="text/css";document.head.appendChild(b)},updateReply:function(b,a){b.addClass("reply-child se-highlight-helper");this.scrollTo(b);var e=b.attr("id");e&&this.replyTo(e.substring(8),a)},registerHandler:function(){var b=this;$("#input").keydown(function(a){var e=$("#input");if(!e.hasClass("editing")){var f=e.val(),c=f.match(/^(:|!!tell ?)($|\d+| )/);
if(c){if(38==a.keyCode||40==a.keyCode){var h=c[1];if(!(e.caret().start>c[0].length+1)){var c=38==a.keyCode?-1:1,d=$(".reply-child.se-highlight-helper");if(0<d.length){d=d.first();d.removeClass("reply-child se-highlight-helper");var g=$(".messages .message");-1==c&&(g=g.reverse());g.each(function(a,c){if($(c).attr("id")==d.attr("id")){var e=$(g[a+1]).first();e&&b.updateReply(e,h)}})}else{g=$(".messages .message");c=g.last();if(!c)return;b.updateReply(c,h);f==h&&(f=e.val().length,e.caret(f,f))}a.preventDefault()}}}else $(".reply-child.se-highlight-helper").removeClass("reply-child se-highlight-helper")}});
$(document).on("click",".newreply",function(a){b.updateReply($(this).parents(".messages .message"))})},enableQuoteBubble:function(){$(document).on("mousemove",function(b){if(null!=replyHelper.quotedMessage){var a=replyHelper.quotedMessage.height();0!=a&&replyHelper.quotedMessage.attr("style","position : absolute;left:"+b.pageX+"px;top:"+(b.pageY-(a+30))+"px;z-index : 3;min-width : 0px;")}});$(document).on("mouseenter",".reply-info",function(b){var a=null;b=$(this).attr("href");var e=b.lastIndexOf("#");
b=b.substr(e+1);var f=$("#message-"+b);if(0<f.length){a=$(".content",f).html();b=f.parents(".user-container").hasClass("mine");var e=null,c=$(".timestamp",f),h=$(f).siblings(".timestamp");0<c.length?e=c:0<h.length&&(e=h);c=null;h=f.parents(".messages").siblings(".signature");0<h.length&&(c=h.clone(),h=$(".tiny-signature",c).detach(),$(c).empty().append(h),$(h).show(),f=f.parents(".messages").css("background-color"),c.attr("style","background-color : "+f+";width : inherit;border-top : 1px solid black;border-right : 1px solid black;border-left : 1px solid black;border-top-left-radius : 6px;border-top-right-radius : 6px;padding : 2px 5px 2px 5px;z-index : 2;position : relative;top : 1px;"));
a=$("<div class='user-container monologue'><div class='messages'><div class='message'><div class='content'>"+a+"</div></div></div></div>");a.attr("style","position : absolute;top : -9999;");$(".messages",a).attr("style","border : 1px solid black;border-top-left-radius : 0;max-width : 660px;width : inherit;");b&&a.addClass("mine");e&&(b=$("<div class='timestamp'>"+e.text()+"</div>"),$(".message",a).before(b));c&&$(".messages",a).before(c);$(this).parents(".monologue").before(a);replyHelper.quotedMessage=
a}});$(document).on("mouseleave",".reply-info",function(b){null!=replyHelper.quotedMessage&&(replyHelper.quotedMessage.remove(),replyHelper.quotedMessage=null)})}};var replyHelper=new ReplyHelper;
